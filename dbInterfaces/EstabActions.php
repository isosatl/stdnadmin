<?phptry {    header("Content-Type: text/html;charset=utf-8");    require('../DB.php');     //    $dbh = null; don't forget to close the connection!        //Getting records (listAction)    if ($_GET["action"] == "list") {        if (!$result = $dbh->prepare("SELECT COUNT(*) AS Registros FROM establecimientos")) {            throw new Exception('Query failed: ' . mysql_error($dbh));        }        $result->execute();        $row = $result->fetch(PDO::FETCH_ASSOC);        $registros = $row['Registros'];        //Get records from database        if (!$result = ("SELECT * FROM establecimientos            ORDER BY " . $_GET["jtSorting"] . " LIMIT " . $_GET["jtStartIndex"] . "," . $_GET["jtPageSize"] . "")) {            throw new Exception('Query failed: ' . mysql_error($dbh));        }        //Add all records to an array        $rows = array();        foreach ($dbh->query($result) as $row) {            $rows[] = $row;        }        //Return result to jTable        $jTableResult = array();        $jTableResult['Result'] = "OK";        $jTableResult['TotalRecordCount'] = $registros;        $jTableResult['Records'] = $rows;        print json_encode($jTableResult);    }    //Creating a new record (createAction)    else if ($_GET["action"] == "create") {        if (!$result = $dbh->prepare("INSERT INTO establecimientos(nombre_establecimiento, localizacion_establecimiento,             estatus_establec_anterior, director_del_establecimiento, telefono_establecimiento)             VALUES('" . $_POST["nombre_establecimiento"] . "', '" . $_POST["localizacion_establecimiento"] . "', '"             . $_POST["estatus_establec_anterior"] . "', '" . $_POST["director_del_establecimiento"] . "','"             . $_POST["telefono_establecimiento"] . "' );")) {            throw new Exception('Query failed: ' . mysql_error($dbh));        }        $result->execute();        //Get last inserted record (to return to jTable)        $result = $dbh->prepare("SELECT * FROM establecimientos WHERE id_establecimientos = LAST_INSERT_ID();");        $result->execute();        $row = $result->fetch(PDO::FETCH_ASSOC);        //Return result to jTable        $jTableResult = array();        $jTableResult['Result'] = "OK";        $jTableResult['Record'] = $row;        print json_encode($jTableResult);    }    //Updating a record (updateAction)    else if ($_GET["action"] == "update") {        if (!$result = $dbh->prepare("UPDATE establecimientos SET nombre_establecimiento = '"             . $_POST["nombre_establecimiento"] . "', localizacion_establecimiento = '"             . $_POST["localizacion_establecimiento"] . "', estatus_establec_anterior = '"             . $_POST["estatus_establec_anterior"] . "', director_del_establecimiento = '"             . $_POST["director_del_establecimiento"] . "', telefono_establecimiento = '"             . $_POST["telefono_establecimiento"] . "'  WHERE id_establecimientos = "             . $_POST["id_establecimientos"] . ";")){            throw new Exception('Query failed: ' . mysql_error($dbh));                    }        $result->execute();        //Return result to jTable        $jTableResult = array();        $jTableResult['Result'] = "OK";        print json_encode($jTableResult);    }    //Deleting a record (deleteAction)    else if ($_GET["action"] == "delete") {        if (!$result = $dbh->prepare("DELETE FROM establecimientos WHERE id_establecimientos = "             . $_POST["id_establecimientos"] . ";")){            throw new Exception('Query failed: ' . mysql_error($dbh));                    }        $result->execute();        //Return result to jTable        $jTableResult = array();        $jTableResult['Result'] = "OK";        print json_encode($jTableResult);    }    else if ($_GET["action"] == "establecimiento") {        $rows = array();        if (!$result = ("SELECT nombre_establecimiento AS DisplayText, id_establecimientos AS Value FROM establecimientos ")) {            throw new Exception('Query failed: ' . mysql_error($dbh));                                                                              }        //Add all records to an array        foreach ($dbh->query($result) as $row) {            $rows[] = $row;        }                //Return result to jTable        $jTableResult = array();        $jTableResult['Result'] = "OK";        $jTableResult['Options'] = $rows;        print json_encode($jTableResult);    }        /* close the database connection */    $dbh = null;    if ($dbh) {        var_dump($dbh, " connection still active");    }} catch (Exception $ex) {    $ex->getMessage();    print $ex;    //Return error message    $jTableResult = array();    $jTableResult['Result'] = "ERROR";    $jTableResult['Message'] = $ex->getMessage();    print json_encode($jTableResult);}?>